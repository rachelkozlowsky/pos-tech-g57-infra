name: "Apply to Production"

on:
  push:
    branches:
      - 'main'
    paths:
      - 'infra/**'  # Só executa quando houver mudanças na pasta infra

jobs:
  terraform-apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest

    # Só executa quando o evento é um push para main e há mudanças na pasta infra
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.commits[0].modified, 'infra/')

    defaults:
      run:
        working-directory: ./infra

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false

#      - name: Terraform Apply
#        run: terraform apply -auto-approve -input=false

  notify-deployment:
    name: "Notify Deployment Status"
    needs: [terraform-plan]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.commits[0].modified, 'infra/')
    runs-on: ubuntu-latest

    steps:
      - name: Check Terraform Apply Status
        id: check-status
        run: |
          if [ "${{ needs.terraform-apply.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Terraform apply executado com sucesso em produção!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=ERRO: Falha ao executar Terraform apply em produção!" >> $GITHUB_OUTPUT
          fi

      - name: Send Notification
        run: |
          echo "${{ steps.check-status.outputs.message }}"
          # Adicione aqui notificações adicionais (email, Slack, etc.)